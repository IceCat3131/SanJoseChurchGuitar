
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å¬ä¼šè¯—æ­Œå‰ä»–è°±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<div class="page">
  <div class="page-inner">
    <!-- ç¬¬ 1 éƒ¨åˆ†ï¼šå›ºå®šæ ‡é¢˜ -->
    <div class="page-title">å¬ä¼šè¯—æ­Œå‰ä»–è°±</div>

    <!-- ç¬¬ 2 éƒ¨åˆ†ï¼šæœç´¢æ¡† -->
    <div class="card" id="search-card">
      <div class="search-bar">
        <div class="search-book-toggle">
          <button class="search-book-btn active" data-book="c" id="btn-book-c">å¤§æœ¬</button>
          <div class="search-book-divider"></div>
          <button class="search-book-btn" data-book="ts" id="btn-book-ts">å°æœ¬</button>
        </div>
        <div class="search-input-wrap">
          <input
            id="search-input"
            class="search-input"
            type="text"
            inputmode="numeric"
            pattern="[0-9]*"
            placeholder="è¾“å…¥ç¼–å·ï¼Œå¦‚31"
          />
          <button class="search-icon-btn" id="btn-search">
            <span class="search-icon">ğŸ”</span>
          </button>
        </div>
      </div>
    </div>

    <!-- ç¬¬ 3 éƒ¨åˆ†ï¼šåˆ—è¡¨ -->
    <div class="list-card">
      <ul class="song-list" id="song-list">
        <!-- JS æ¸²æŸ“ -->
      </ul>
    </div>

    <!-- ç¬¬ 4 éƒ¨åˆ†ï¼šå£°æ˜ -->
    <div class="footer-text">æœ¬ç½‘ç«™ä»…ä¾›è¯—æ­Œå‰ä»–è°±æŸ¥é˜…ä½¿ç”¨</div>
  </div>
</div>

<script>
  const BOOKS = {
    c: {
      label: "å¤§æœ¬è¯—æ­Œ",
      folderText: "c_text",
      codePrefix: "c"
    },
    ts: {
      label: "å°æœ¬è¯—æ­Œ",
      folderText: "ts_text",
      codePrefix: "ts"
    }
  };

  const MAX_RANGES = 20;

  const state = {
    currentBook: "c",
    data: { c: [], ts: [] },
    loadedRanges: { c: {}, ts: {} },
    loaded: { c: false, ts: false },    // æ¯å†Œæ˜¯å¦åŠ è½½è¿‡
    loading: false                      // æ­£åœ¨åŠ è½½æ—¶ç¦æ­¢è¿ç‚¹
  };

  function pad4(num) {
    return String(num).padStart(4, "0");
  }

  function getRangeFilePath(bookKey, rangeIndex) {
    const start = rangeIndex * 100 + 1;
    const end = (rangeIndex + 1) * 100;
    const folder = BOOKS[bookKey].folderText;
    return `assets/${folder}/${bookKey}_${start}_${end}.json`;
  }

  async function loadRange(bookKey, rangeIndex) {
    if (state.loadedRanges[bookKey][rangeIndex]) return true;

    const url = getRangeFilePath(bookKey, rangeIndex);
    try {
      const res = await fetch(url);
      if (!res.ok) {
        state.loadedRanges[bookKey][rangeIndex] = true;
        return false;
      }
      const json = await res.json();
      if (!Array.isArray(json) || json.length === 0) {
        state.loadedRanges[bookKey][rangeIndex] = true;
        return false;
      }

      state.data[bookKey] = state.data[bookKey].concat(json);
      state.loadedRanges[bookKey][rangeIndex] = true;
      return true;

    } catch (e) {
      console.error("åŠ è½½å¤±è´¥:", bookKey, rangeIndex, e);
      state.loadedRanges[bookKey][rangeIndex] = true;
      return false;
    }
  }

  async function loadAllRangesForBook(bookKey) {
    if (state.loaded[bookKey]) return;     // å·²ç»åŠ è½½è¿‡ï¼Œä¸é‡å¤åŠ è½½

    state.loading = true;

    for (let i = 0; i < MAX_RANGES; i++) {
      const ok = await loadRange(bookKey, i);
      if (!ok) break;
    }

    state.data[bookKey].sort((a, b) => (a.no || 0) - (b.no || 0));
    state.loaded[bookKey] = true;
    state.loading = false;
  }

  function renderList(bookKey) {
    const listEl = document.getElementById("song-list");
    const songs = state.data[bookKey] || [];
    listEl.innerHTML = "";

    songs.forEach(song => {
      if (!song.no) return;
      const no = song.no;
      const code = BOOKS[bookKey].codePrefix + pad4(no);

      const li = document.createElement("li");
      li.className = "song-item";
      li.dataset.book = bookKey;
      li.dataset.no = no;

      const label = document.createElement("span");
      label.className = "song-item-label";
      label.textContent = `${BOOKS[bookKey].label} ç¬¬ ${no} é¦–`;

      const codeSpan = document.createElement("span");
      codeSpan.className = "song-item-code";
      codeSpan.textContent = `(${code})`;

      li.appendChild(label);
      li.appendChild(codeSpan);

      li.addEventListener("click", () => {
        goToSong(bookKey, no);
      });

      listEl.appendChild(li);
    });
  }

  function setActiveBook(bookKey) {
    state.currentBook = bookKey;
    document.getElementById("btn-book-c").classList.toggle("active", bookKey === "c");
    document.getElementById("btn-book-ts").classList.toggle("active", bookKey === "ts");
  }

  function goToSong(book, no) {
    window.location.href = `song.html?book=${book}&no=${no}`;
  }

  function handleSearch() {
    const raw = document.getElementById("search-input").value.trim();
    if (!raw) return;

    const match = raw.match(/(\d{1,4})$/);
    if (!match) {
      alert("è¯·è¾“å…¥æ­£ç¡®ç¼–å·ï¼Œå¦‚ï¼š31");
      return;
    }

    const no = parseInt(match[1], 10);
    const exists = state.data[state.currentBook].some(s => s.no === no);
    if (!exists) {
      alert("è¯¥ç¼–å·ä¸åœ¨å½“å‰å†Œä¸­");
      return;
    }

    goToSong(state.currentBook, no);
  }

  document.addEventListener("DOMContentLoaded", async () => {

    // åˆ‡æ¢å¤§æœ¬/å°æœ¬
    document.querySelectorAll(".search-book-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const book = btn.dataset.book;

        if (state.currentBook === book) return;
        if (state.loading) return;     // æ­£åœ¨åŠ è½½ç¦æ­¢è¿ç‚¹

        setActiveBook(book);

        const listEl = document.getElementById("song-list");

        // æ²¡åŠ è½½è¿‡è¯¥å†Œ â†’ æ˜¾ç¤ºâ€œåŠ è½½ä¸­â€
        if (!state.loaded[book]) {
          listEl.innerHTML = '<li class="song-item"><span class="song-item-label">åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...</span></li>';
          await loadAllRangesForBook(book);
        }

        renderList(book);
      });
    });

    // æœç´¢æŒ‰é’®
    document.getElementById("btn-search").addEventListener("click", handleSearch);
    document.getElementById("search-input").addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        handleSearch();
      }
    });

    // åˆå§‹åŠ è½½å¤§æœ¬
    await loadAllRangesForBook("c");
    renderList("c");

    // åå°é¢„åŠ è½½å°æœ¬ï¼ˆæé«˜åˆ‡æ¢é€Ÿåº¦ï¼‰
    loadAllRangesForBook("ts");
  });
</script>

</body>
</html>
