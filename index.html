
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å¬ä¼šè¯—æ­Œå‰ä»–è°±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<div class="page">
  <div class="page-inner">
    <!-- ç¬¬ 1 éƒ¨åˆ†ï¼šå›ºå®šæ ‡é¢˜ -->
    <div class="page-title">å¬ä¼šè¯—æ­Œå‰ä»–è°±</div>

    <!-- ç¬¬ 2 éƒ¨åˆ†ï¼šæœç´¢æ¡† -->
    <div class="card" id="search-card">
      <div class="search-bar">
        <div class="search-book-toggle">
          <button class="search-book-btn active" data-book="c" id="btn-book-c">å¤§æœ¬</button>
          <div class="search-book-divider"></div>
          <button class="search-book-btn" data-book="ts" id="btn-book-ts">å°æœ¬</button>
        </div>
        <div class="search-input-wrap">
          <input
            id="search-input"
            class="search-input"
            type="text"
            inputmode="numeric"
            pattern="[0-9]*"
            placeholder="è¾“å…¥ç¼–å·ï¼Œå¦‚31"
          />
          <button class="search-icon-btn" id="btn-search">
            <span class="search-icon">ğŸ”</span>
          </button>
        </div>
      </div>
    </div>

    <!-- ç¬¬ 3 éƒ¨åˆ†ï¼šåˆ—è¡¨ -->
    <div class="list-card">
      <ul class="song-list" id="song-list">
        <!-- JS æ¸²æŸ“ -->
      </ul>
    </div>

    <!-- ç¬¬ 4 éƒ¨åˆ†ï¼šå£°æ˜ -->
    <div class="footer-text">æœ¬ç½‘ç«™ä»…ä¾›è¯—æ­Œå‰ä»–è°±æŸ¥é˜…ä½¿ç”¨</div>
  </div>
</div>

<script>
  const BOOKS = {
    c: {
      label: "å¤§æœ¬è¯—æ­Œ",
      folderText: "c_text",
      codePrefix: "c"
    },
    ts: {
      label: "å°æœ¬è¯—æ­Œ",
      folderText: "ts_text",
      codePrefix: "ts"
    }
  };

  // æœ€å¤šå°è¯•å¤šå°‘ä¸ªåŒºé—´ï¼š0=1-100, 1=101-200, ...
  const MAX_RANGES = 20;

  const state = {
    currentBook: "c",
    // data[book] = æ­Œæ›²æ•°ç»„
    data: { c: [], ts: [] },
    // loadedRanges[book][rangeIndex] = æ˜¯å¦å·²ç»å°è¯•è¿‡è¿™ä¸ª json
    loadedRanges: { c: {}, ts: {} }
  };

  function pad4(num) {
    return String(num).padStart(4, "0");
  }

  function getRangeFilePath(bookKey, rangeIndex) {
    const start = rangeIndex * 100 + 1;
    const end = (rangeIndex + 1) * 100;
    const folder = BOOKS[bookKey].folderText;
    // æ¯”å¦‚ï¼šassets/c_text/c_1_100.json
    return `assets/${folder}/${bookKey}_${start}_${end}.json`;
  }

  async function loadRange(bookKey, rangeIndex) {
    if (state.loadedRanges[bookKey][rangeIndex]) return true; // å·²å°è¯•è¿‡

    const url = getRangeFilePath(bookKey, rangeIndex);
    try {
      const res = await fetch(url);
      if (!res.ok) {
        // 404 æˆ–å…¶ä»–é”™è¯¯ï¼šè®¤ä¸ºæ²¡æœ‰æ›´å¤šæ•°æ®ï¼Œè¿”å› false è®©ä¸Šå±‚åœæ­¢ç»§ç»­å¾€ååŠ è½½
        state.loadedRanges[bookKey][rangeIndex] = true;
        return false;
      }
      const json = await res.json();
      if (!Array.isArray(json) || json.length === 0) {
        state.loadedRanges[bookKey][rangeIndex] = true;
        return false;
      }
      state.data[bookKey] = state.data[bookKey].concat(json);
      state.loadedRanges[bookKey][rangeIndex] = true;
      return true;
    } catch (e) {
      console.error("åŠ è½½åŒºé—´å¤±è´¥", bookKey, rangeIndex, e);
      state.loadedRanges[bookKey][rangeIndex] = true;
      return false;
    }
  }

  // é¦–é¡µéœ€è¦æŠŠæŸå†Œçš„æ‰€æœ‰ json éƒ½è¯»ä¸€éï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶
  async function loadAllRangesForBook(bookKey) {
    state.data[bookKey] = [];
    for (let i = 0; i < MAX_RANGES; i++) {
      const ok = await loadRange(bookKey, i);
      if (!ok) break;
    }
    // æŒ‰ no æ’åºä¸€ä¸‹
    state.data[bookKey].sort((a, b) => (a.no || 0) - (b.no || 0));
  }

  function renderList(bookKey) {
    const listEl = document.getElementById("song-list");
    const songs = state.data[bookKey] || [];
    listEl.innerHTML = "";

    songs.forEach(song => {
      const no = song.no;
      if (!no) return;
      const code = BOOKS[bookKey].codePrefix + pad4(no);

      const li = document.createElement("li");
      li.className = "song-item";
      li.dataset.book = bookKey;
      li.dataset.no = no;

      const labelSpan = document.createElement("span");
      labelSpan.className = "song-item-label";
      labelSpan.textContent = `${BOOKS[bookKey].label} ç¬¬ ${no} é¦–`;

      const codeSpan = document.createElement("span");
      codeSpan.className = "song-item-code";
      codeSpan.textContent = `(${code})`;

      li.appendChild(labelSpan);
      li.appendChild(codeSpan);

      li.addEventListener("click", () => {
        goToSong(bookKey, no);
      });

      listEl.appendChild(li);
    });
  }

  function setActiveBook(bookKey) {
    state.currentBook = bookKey;
    document.getElementById("btn-book-c").classList.toggle("active", bookKey === "c");
    document.getElementById("btn-book-ts").classList.toggle("active", bookKey === "ts");
  }

  function goToSong(book, no) {
    window.location.href = `song.html?book=${encodeURIComponent(book)}&no=${encodeURIComponent(no)}`;
  }

  function handleSearch() {
    const raw = document.getElementById("search-input").value.trim();
    if (!raw) return;
    const digitsMatch = raw.match(/(\d{1,4})$/);
    if (!digitsMatch) {
      alert("è¯·è¾“å…¥æ­£ç¡®çš„ç¼–å·ï¼Œå¦‚ 31");
      return;
    }
    const no = parseInt(digitsMatch[1], 10);
    if (!Number.isFinite(no)) {
      alert("è¯·è¾“å…¥æ­£ç¡®çš„ç¼–å·ï¼Œå¦‚ 31");
      return;
    }
    const songs = state.data[state.currentBook] || [];
    const exists = songs.some(s => s.no === no);
    if (!exists) {
      alert("å½“å‰å†Œä¸­æ‰¾ä¸åˆ°è¯¥ç¼–å·ã€‚");
      return;
    }
    goToSong(state.currentBook, no);
  }

  document.addEventListener("DOMContentLoaded", async () => {
    // ç»‘å®šâ€œå¤§æœ¬ / å°æœ¬â€
    document.querySelectorAll(".search-book-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const book = btn.dataset.book;
        if (state.currentBook === book) return;
        setActiveBook(book);
        await loadAllRangesForBook(book);
        renderList(book);
      });
    });

    document.getElementById("btn-search").addEventListener("click", handleSearch);
    document.getElementById("search-input").addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        handleSearch();
      }
    });

    // åˆå§‹åŠ è½½å¤§æœ¬ï¼šè‡ªåŠ¨æŠŠ c_1_100ã€c_101_200â€¦â€¦ è¯»å‡ºæ¥ï¼ˆé‡åˆ°ç¬¬ä¸€ä¸ªç¼ºå¤±å°±åœæ­¢ï¼‰
    await loadAllRangesForBook("c");
    renderList("c");
  });
</script>
</body>
</html>
