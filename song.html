<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>è¯—æ­Œå‰ä»–è°±æŸ¥çœ‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="page">
        <header class="header-song">
      <a href="index.html" class="back-arrow">â†</a>
      <div class="title-row">
        <button id="btn-prev" class="nav-arrow">&lt;</button>
        <h1 id="song-title">è¯—æ­Œå‰ä»–è°±</h1>
        <button id="btn-next" class="nav-arrow">&gt;</button>
      </div>
    </header>

    <section class="controls">
          <div class="book-switch">
            <button id="btn-book-c" class="book-button active" data-book="c">å¤§æœ¬</button>
            <button id="btn-book-ts" class="book-button" data-book="ts">å°æœ¬</button>
          </div>
          <div class="search-area">
            <input id="search-no" type="number" min="1" placeholder="è¾“å…¥ç¼–å·ï¼Œå¦‚ 7 æˆ– 788">
            <button id="search-btn" class="search-button" title="è·³è½¬åˆ°è¯¥ç¼–å·">ğŸ”</button>
          </div>
        </section>
        <section class="view-toolbar">
          <div class="view-tools-left">
            <button id="btn-font-plus" class="font-button">+</button>
            <button id="btn-font-minus" class="font-button">â€”â€”</button>
          </div>
          <div class="view-switch">
            <button id="btn-view-guitar" class="view-button active">å‰ä»–</button>
            <button id="btn-view-lyrics" class="view-button">æ­Œè¯</button>
          </div>
          <div class="view-tools-right">
            <button id="btn-lang-toggle" class="lang-button">ç¹</button>
          </div>
        </section>


    <main>
      <div id="score-container" class="score-container">
        <!-- SVG å°†æ’å…¥åˆ°è¿™é‡Œ -->
      </div>
    </main>

    <footer class="footer">
      <p id="file-info" class="file-info"></p>
    </footer>
  </div>
  <script>
    // ä¸é¦–é¡µç›¸åŒçš„å†Œåˆ«é…ç½®
    const HYMNBOOKS = {
      c: { id: "c", label: "å¤§æœ¬è¯—æ­Œ", prefix: "c", count: 1000, folder: "c" },
      ts: { id: "ts", label: "å°æœ¬è¯—æ­Œ", prefix: "ts", count: 1000, folder: "ts" }
    };

    function getParams() {
      const params = new URLSearchParams(location.search);
      let book = params.get("book") || "c";
      let no = parseInt(params.get("no") || "1", 10);
      if (!(book in HYMNBOOKS)) book = "c";
      const cfg = HYMNBOOKS[book];
      if (isNaN(no) || no < 1) no = 1;
      if (no > cfg.count) no = cfg.count;
      return { book, no };
    }

    function pad4(n) {
      return String(n).padStart(4, "0");
    }

    // å½“å‰é€‰ä¸­çš„å†Œï¼ˆç»™æœç´¢ç”¨ï¼‰
    let currentBook = "c";
    let currentView = "guitar";

    // å½“å‰æ­Œè¯æ˜¾ç¤ºè¯­è¨€ï¼šsimplified = ç®€ä½“, traditional = ç¹ä½“
    let currentLang = "simplified";
    // ç¼“å­˜æ­Œè¯ HTMLï¼Œç”¨äºåˆ‡æ¢ç®€ç¹å’Œå­—å·
    let baseLyricsHtml = "";
    // å½“å‰æ­Œè¯å­—å·ï¼ˆåƒç´ ï¼‰
    let currentFontSize = 20;

    function applyLyricsFontSize() {
      const el = document.querySelector(".lyrics-container");
      if (el) {
        el.style.fontSize = currentFontSize + "px";
      }
    }

    // ç®€å•çš„ç®€ä½“ -> ç¹ä½“è½¬æ¢ï¼ˆå¸¸ç”¨é«˜é¢‘å­—ï¼‰
    function toTraditional(text) {
      const map = {
        "èµ": "è®š",
        "é¢‚": "é Œ",
        "çµ": "éˆ",
        "åœ£": "è–",
        "ä¹": "æ¨‚",
        "çˆ±": "æ„›",
        "å›½": "åœ‹",
        "å¹¿": "å»£",
        "å‘": "ç™¼",
        "å£°": "è²",
        "å¤": "å¾©",
        "ä¼—": "çœ¾",
        "è£": "æ¦®",
        "ä¹‰": "ç¾©",
        "é—¨": "é–€",
        "æ—¶": "æ™‚",
        "é‡Œ": "è£¡",
        "å°": "è‡º",
        "å¯": "å•Ÿ",
        "ç°": "ç¾",
        "ä¼š": "æœƒ",
        "è§‚": "è§€",
        "ç»": "ç¶“",
        "è¯": "è©±"
      };
      return text.replace(/./g, ch => map[ch] || ch);
    }

    function renderLyrics() {
      const container = document.getElementById("score-container");
      if (!container || !baseLyricsHtml) return;
      let html = baseLyricsHtml;
      if (currentLang === "traditional") {
        html = toTraditional(html);
      }
      container.innerHTML = html;
      applyLyricsFontSize();
    }

function applyBookUI(book) {
      const btnBookC = document.getElementById("btn-book-c");
      const btnBookTs = document.getElementById("btn-book-ts");
      if (btnBookC && btnBookTs) {
        btnBookC.classList.toggle("active", book === "c");
        btnBookTs.classList.toggle("active", book === "ts");
      }
      currentBook = book;
    }

    
    function showGuitar(book, no) {
      const cfg = HYMNBOOKS[book];
      const titleEl = document.getElementById("song-title");
      const infoEl = document.getElementById("file-info");
      const container = document.getElementById("score-container");
      if (!titleEl || !container) return;

      const noStr = pad4(no);
      const filename = `${cfg.prefix}${noStr}_cn_g.svg`;
      const path = `assets/${cfg.folder}/${filename}`;

      titleEl.textContent = `${cfg.label} ç¬¬ ${no} é¦–`;
      document.title = `${titleEl.textContent} - å¬ä¼šè¯—æ­Œå‰ä»–è°±`;
      if (infoEl) infoEl.textContent = "";

      container.innerHTML = "";
      const img = document.createElement("img");
      img.src = path;
      img.alt = titleEl.textContent;
      img.className = "score-svg";
      container.appendChild(img);
    }

    
    // æ ¹æ® JSON ä¸­çš„ title æ›´æ–°é¡µé¢é¡¶éƒ¨æ ‡é¢˜
    function updateTitleFromJson(book, no) {
      const titleEl = document.getElementById("song-title");
      if (!titleEl) return;

      const cfg = HYMNBOOKS[book];
      const groupStart = Math.floor((no - 1) / 100) * 100 + 1;
      const groupEnd = groupStart + 99;
      const bookFolder = book === "c" ? "c_text" : "ts_text";
      const jsonFile = `${book}_${groupStart}_${groupEnd}.json`;
      const jsonPath = `assets/${bookFolder}/${jsonFile}`;

      fetch(jsonPath)
        .then((resp) => {
          if (!resp.ok) throw new Error("ç½‘ç»œé”™è¯¯");
          return resp.json();
        })
        .then((list) => {
          const song = list.find((item) => String(item.no) === String(no));
          if (!song || !song.title) return;
          const t = song.title;
          titleEl.textContent = t;
          document.title = `${t} - å¬ä¼šè¯—æ­Œå‰ä»–è°±`;
        })
        .catch((err) => {
          console.error("updateTitleFromJson error", err);
          // å‡ºé”™æ—¶ä¿æŒåŸæ¥çš„æ ‡é¢˜ï¼ˆå¤§æœ¬è¯—æ­Œ ç¬¬ X é¦–ï¼‰
        });
    }


    function loadLyrics(book, no) {
      const container = document.getElementById("score-container");
      const infoEl = document.getElementById("file-info");
      if (!container) return;

      if (infoEl) infoEl.textContent = "";
      container.innerHTML = '<p class="lyrics-loading">æ­Œè¯åŠ è½½ä¸­â€¦</p>';

      const groupStart = Math.floor((no - 1) / 100) * 100 + 1;
      const groupEnd = groupStart + 99;
      const bookFolder = book === "c" ? "c_text" : "ts_text";
      const jsonFile = `${book}_${groupStart}_${groupEnd}.json`;
      const jsonPath = `assets/${bookFolder}/${jsonFile}`;

      fetch(jsonPath)
        .then((resp) => {
          if (!resp.ok) throw new Error("ç½‘ç»œé”™è¯¯");
          return resp.json();
        })
        .then((list) => {
          const song = list.find((item) => String(item.no) === String(no));
          if (!song || !Array.isArray(song.lyrics)) {
            throw new Error("æœªæ‰¾åˆ°è¯¥é¦–æ­Œè¯");
          }

          // æ›´æ–°é¡¶éƒ¨æ ‡é¢˜ä¸º JSON ä¸­çš„ title
          updateTitleFromJson(book, no);

          let html = '<div class="lyrics-container">';
          (song.lyrics || []).forEach((sec) => {
            if (!sec || !Array.isArray(sec.lines)) return;
            html += '<div class="lyrics-section">';
            if (sec.section_no) {
              html += `<div class="lyrics-section-no">${sec.section_no}</div>`;
            }
            html += '<div class="lyrics-lines">';
            sec.lines.forEach((line) => {
              html += `<p>${line}</p>`;
            });
            html += "</div></div>";
          });
          html += "</div>";

          baseLyricsHtml = html;
          renderLyrics();
        })
        .catch((err) => {
          console.error(err);
          container.innerHTML = '<p class="lyrics-error">æ²¡æœ‰æ‰¾åˆ°æ­Œè¯æˆ–åŠ è½½å¤±è´¥ã€‚</p>';
        });
    }


    function updatePage() {
      const { book, no } = getParams();
      applyBookUI(book);

      const searchInput = document.getElementById("search-no");
      if (searchInput) searchInput.value = no;

      // æ ‡é¢˜ç»Ÿä¸€ä½¿ç”¨ JSON é‡Œçš„ title
      updateTitleFromJson(book, no);

      if (currentView === "lyrics") {
        loadLyrics(book, no);
      } else {
        showGuitar(book, no);
      }
    }

function gotoSong(book, no) {
      const cfg = HYMNBOOKS[book];
      if (no < 1) no = 1;
      if (no > cfg.count) no = cfg.count;
      location.search = `?book=${book}&no=${no}`;
    }

    // å·¦å³ç®­å¤´ä¸Šä¸€é¦–/ä¸‹ä¸€é¦–
    document.getElementById("btn-prev").addEventListener("click", () => {
      const { book, no } = getParams();
      gotoSong(book, no - 1);
    });

    document.getElementById("btn-next").addEventListener("click", () => {
      const { book, no } = getParams();
      gotoSong(book, no + 1);
    });

    // æœç´¢æ é€»è¾‘ï¼ˆå’Œé¦–é¡µä¿æŒä¸€è‡´çš„è¡Œä¸ºï¼‰
    (function setupSearch() {
      const btnBookC = document.getElementById("btn-book-c");
      const btnBookTs = document.getElementById("btn-book-ts");
      const searchInput = document.getElementById("search-no");
      const searchBtn = document.getElementById("search-btn");

      if (!searchInput || !searchBtn || !btnBookC || !btnBookTs) return;

      btnBookC.addEventListener("click", () => {
        applyBookUI("c");
      });

      btnBookTs.addEventListener("click", () => {
        applyBookUI("ts");
      });

      function jumpToSong() {
        const val = searchInput.value.trim();
        if (!val) {
          alert("è¯·è¾“å…¥ç¼–å·ï¼Œä¾‹å¦‚ 7 æˆ– 788");
          return;
        }
        const no = parseInt(val, 10);
        const cfg = HYMNBOOKS[currentBook];
        if (isNaN(no) || no < 1 || no > cfg.count) {
          alert(`è¯·è¾“å…¥ 1 - ${cfg.count} ä¹‹é—´çš„ç¼–å·`);
          return;
        }
        gotoSong(currentBook, no);
      }

      searchBtn.addEventListener("click", jumpToSong);
      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          jumpToSong();
        }
      });
    })();

    // è§†å›¾åˆ‡æ¢ï¼ˆå‰ä»– / æ­Œè¯ï¼‰
    (function setupViewSwitch() {
      const btnViewGuitar = document.getElementById("btn-view-guitar");
      const btnViewLyrics = document.getElementById("btn-view-lyrics");
      if (!btnViewGuitar || !btnViewLyrics) return;

      function applyView(view) {
        currentView = view;
        btnViewGuitar.classList.toggle("active", view === "guitar");
        btnViewLyrics.classList.toggle("active", view === "lyrics");
        updatePage();
      }

      btnViewGuitar.addEventListener("click", () => applyView("guitar"));
      btnViewLyrics.addEventListener("click", () => applyView("lyrics"));
    })();

    // å­—å· + / - æ§åˆ¶
    (function setupFontControls() {
      const btnPlus = document.getElementById("btn-font-plus");
      const btnMinus = document.getElementById("btn-font-minus");
      if (!btnPlus || !btnMinus) return;

      btnPlus.addEventListener("click", () => {
        currentFontSize += 2;
        if (currentFontSize > 32) currentFontSize = 32;
        applyLyricsFontSize();
      });

      btnMinus.addEventListener("click", () => {
        currentFontSize -= 2;
        if (currentFontSize < 12) currentFontSize = 12;
        applyLyricsFontSize();
      });
    })();

    // ç®€ / ç¹ åˆ‡æ¢ï¼ˆå•æŒ‰é’®ï¼‰
    (function setupLangToggle() {
      const btnLang = document.getElementById("btn-lang-toggle");
      if (!btnLang) return;

      function applyLang(lang) {
        currentLang = lang;
        btnLang.textContent = (lang === "simplified") ? "ç¹" : "ç®€";
        renderLyrics();
      }

      // åˆå§‹åŒ–ï¼šé»˜è®¤ç®€ä½“ï¼ŒæŒ‰é’®æ–‡æ¡ˆä¸ºâ€œç¹â€
      applyLang(currentLang);

      btnLang.addEventListener("click", () => {
        const next = currentLang === "simplified" ? "traditional" : "simplified";
        applyLang(next);
      });
    })();


// åˆæ¬¡åŠ è½½å½“å‰é¡µ
    updatePage();
  </script>
</body>
</html>
