<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å¬ä¼šè¯—æ­Œå‰ä»–è°±</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="site-header">
    <h1 id="song-title">åŠ è½½ä¸­â€¦</h1>
    <p id="song-subtitle" class="site-subtitle"></p>
    <p id="file-info" class="file-info"></p>
  </header>

  <section class="controls">
    <div class="book-switch">
      <button id="btn-book-c" class="book-button active" data-book="c">å¤§æœ¬</button>
      <button id="btn-book-ts" class="book-button" data-book="ts">å°æœ¬</button>
    </div>

    <div class="search-area">
      <input id="search-no" type="number" min="1" placeholder="è¾“å…¥ç¼–å·ï¼Œå¦‚ 7 æˆ– 788" />
      <button id="search-btn" class="search-button" title="è·³è½¬åˆ°è¯¥ç¼–å·">ğŸ”</button>
    </div>

    <div class="view-switch">
      <button id="btn-view-guitar" class="view-button active">å‰ä»–</button>
      <button id="btn-view-lyrics" class="view-button">æ­Œè¯</button>
    </div>
  </section>

  <section class="nav-buttons">
    <button id="btn-prev" class="nav-button">ä¸Šä¸€é¦–</button>
    <button id="btn-next" class="nav-button">ä¸‹ä¸€é¦–</button>
  </section>

  <main>
    <div id="score-container" class="score-container">
      <!-- SVG å‰ä»–è°±æ’å…¥åœ¨è¿™é‡Œ -->
    </div>

    <div id="lyrics-container" class="lyrics-container" style="display:none;">
      <!-- æ­Œè¯ JSON æ¸²æŸ“åœ¨è¿™é‡Œ -->
    </div>
  </main>

  <footer class="site-footer">
    <span>å·¦ä¸Šåˆ‡æ¢å†Œåˆ«ï¼Œæœç´¢ç¼–å·ï¼›ä¸­é—´å‰ä»– / æ­Œè¯åˆ‡æ¢ã€‚</span>
  </footer>

  <script>
    const HYMNBOOKS = {
      c: { id: "c", label: "å¤§æœ¬è¯—æ­Œ", prefix: "c", count: 1000, folder: "c" },
      ts: { id: "ts", label: "å°æœ¬è¯—æ­Œ", prefix: "ts", count: 1000, folder: "ts" }
    };

    function getParams() {
      const params = new URLSearchParams(location.search);
      let book = params.get("book") || "c";
      let no = parseInt(params.get("no") || "1", 10);
      if (!(book in HYMNBOOKS)) book = "c";
      const cfg = HYMNBOOKS[book];
      if (isNaN(no) || no < 1) no = 1;
      if (no > cfg.count) no = cfg.count;
      return { book, no };
    }

    function pad4(n) {
      return String(n).padStart(4, "0");
    }

    let currentBook = "c";

    function applyBookUI(book) {
      const btnBookC = document.getElementById("btn-book-c");
      const btnBookTs = document.getElementById("btn-book-ts");
      if (btnBookC && btnBookTs) {
        btnBookC.classList.toggle("active", book === "c");
        btnBookTs.classList.toggle("active", book === "ts");
      }
      currentBook = book;
    }

    let currentView = "guitar";

    function applyViewUI(view) {
      const btnGuitar = document.getElementById("btn-view-guitar");
      const btnLyrics = document.getElementById("btn-view-lyrics");
      if (btnGuitar && btnLyrics) {
        btnGuitar.classList.toggle("active", view === "guitar");
        btnLyrics.classList.toggle("active", view === "lyrics");
      }
    }

    function getLyricsJsonPath(book, no) {
      if (book === "c") {
        return `assets/c_text/ch_${no}.json`;
      } else if (book === "ts") {
        return `assets/ts_text/ts_${no}.json`;
      }
      return "";
    }

    async function loadLyrics(book, no) {
      const lyricsContainer = document.getElementById("lyrics-container");
      const subEl = document.getElementById("song-subtitle");
      const infoEl = document.getElementById("file-info");
      if (!lyricsContainer) return;

      const jsonPath = getLyricsJsonPath(book, no);
      if (!jsonPath) {
        lyricsContainer.innerHTML = "<div class=\"lyrics-error\">æœªé…ç½®è¯¥å†Œçš„æ­Œè¯è·¯å¾„</div>";
        return;
      }

      lyricsContainer.innerHTML = "<div class=\"lyrics-loading\">æ­£åœ¨åŠ è½½æ­Œè¯â€¦</div>";
      if (infoEl) infoEl.textContent = `æ­Œè¯æ–‡ä»¶: ${jsonPath}`;

      try {
        const resp = await fetch(jsonPath);
        if (!resp.ok) {
          throw new Error("HTTP " + resp.status);
        }
        const data = await resp.json();

        if (subEl && data.title) {
          subEl.textContent = data.title;
        }

        if (!data.verses || !Array.isArray(data.verses) || data.verses.length === 0) {
          lyricsContainer.innerHTML = "<div class=\"lyrics-error\">è¯¥é¦–æš‚æ— æ­Œè¯å†…å®¹</div>";
          return;
        }

        let html = "";
        data.verses.forEach((stanza, idx) => {
          const lines = (stanza || []).map(line =>
            `<div class="lyrics-line">${line}</div>`
          ).join("");
          html += `
            <div class="lyrics-stanza">
              <div class="lyrics-stanza-index">${idx + 1}</div>
              <div class="lyrics-stanza-body">
                ${lines}
              </div>
            </div>
          `;
        });
        lyricsContainer.innerHTML = html;
      } catch (err) {
        console.error("åŠ è½½æ­Œè¯å¤±è´¥", err);
        lyricsContainer.innerHTML =
          `<div class="lyrics-error">æœªæ‰¾åˆ°æ­Œè¯æ–‡ä»¶æˆ–è§£æå¤±è´¥ï¼š${jsonPath}</div>`;
      }
    }

    function updatePage() {
      const { book, no } = getParams();
      const cfg = HYMNBOOKS[book];

      applyBookUI(book);
      const searchInput = document.getElementById("search-no");
      if (searchInput) searchInput.value = no;

      const titleEl = document.getElementById("song-title");
      const subEl = document.getElementById("song-subtitle");
      const infoEl = document.getElementById("file-info");
      const scoreContainer = document.getElementById("score-container");
      const lyricsContainer = document.getElementById("lyrics-container");

      const noStr = pad4(no);
      const filename = `${cfg.prefix}${noStr}_cn_g.svg`;
      const path = `assets/${cfg.folder}/${filename}`;

      titleEl.textContent = `${cfg.label} ç¬¬ ${no} é¦–`;
      if (subEl) subEl.textContent = "";
      if (infoEl) infoEl.textContent = "";

      if (scoreContainer) {
        scoreContainer.innerHTML = "";
        const img = document.createElement("img");
        img.src = path;
        img.alt = titleEl.textContent;
        img.className = "score-svg";
        scoreContainer.appendChild(img);
      }

      if (currentView === "lyrics") {
        if (scoreContainer) scoreContainer.style.display = "none";
        if (lyricsContainer) {
          lyricsContainer.style.display = "block";
          loadLyrics(book, no);
        }
      } else {
        if (scoreContainer) scoreContainer.style.display = "block";
        if (lyricsContainer) lyricsContainer.style.display = "none";
      }

      applyViewUI(currentView);
      document.title = `${titleEl.textContent} - å¬ä¼šè¯—æ­Œå‰ä»–è°±`;
    }

    function gotoSong(book, no) {
      const cfg = HYMNBOOKS[book];
      if (no < 1) no = 1;
      if (no > cfg.count) no = cfg.count;
      location.search = `?book=${book}&no=${no}`;
    }

    const btnViewGuitar = document.getElementById("btn-view-guitar");
    const btnViewLyrics = document.getElementById("btn-view-lyrics");
    if (btnViewGuitar && btnViewLyrics) {
      btnViewGuitar.addEventListener("click", () => {
        currentView = "guitar";
        updatePage();
      });
      btnViewLyrics.addEventListener("click", () => {
        currentView = "lyrics";
        updatePage();
      });
    }

    document.getElementById("btn-prev").addEventListener("click", () => {
      const { book, no } = getParams();
      gotoSong(book, no - 1);
    });

    document.getElementById("btn-next").addEventListener("click", () => {
      const { book, no } = getParams();
      gotoSong(book, no + 1);
    });

    (function setupSearch() {
      const btnBookC = document.getElementById("btn-book-c");
      const btnBookTs = document.getElementById("btn-book-ts");
      const searchInput = document.getElementById("search-no");
      const searchBtn = document.getElementById("search-btn");

      if (!searchInput || !searchBtn || !btnBookC || !btnBookTs) return;

      btnBookC.addEventListener("click", () => {
        applyBookUI("c");
      });

      btnBookTs.addEventListener("click", () => {
        applyBookUI("ts");
      });

      function jumpToSong() {
        const raw = searchInput.value.trim();
        const no = parseInt(raw, 10);
        const book = currentBook || "c";
        if (isNaN(no) || no < 1 || no > 1000) {
          alert("è¯·è¾“å…¥ 1~1000 ç¼–å·");
          return;
        }
        gotoSong(book, no);
      }

      searchBtn.addEventListener("click", jumpToSong);
      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          jumpToSong();
        }
      });
    })();

    updatePage();
  </script>
</body>
</html>
