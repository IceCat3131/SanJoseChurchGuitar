<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>è¯—æ­Œå‰ä»–è°±æŸ¥çœ‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="page">
        <header class="header-song">
      <a href="index.html" class="back-arrow">â†</a>
      <div class="title-row">
        <button id="btn-prev" class="nav-arrow">&lt;</button>
        <h1 id="song-title">è¯—æ­Œå‰ä»–è°±</h1>
        <button id="btn-next" class="nav-arrow">&gt;</button>
      </div>
    </header>

    <section class="controls">
          <div class="book-switch">
            <button id="btn-book-c" class="book-button active" data-book="c">å¤§æœ¬</button>
            <button id="btn-book-ts" class="book-button" data-book="ts">å°æœ¬</button>
          </div>
          <div class="search-area">
            <input id="search-no" type="number" min="1" placeholder="è¾“å…¥ç¼–å·ï¼Œå¦‚ 7 æˆ– 788">
            <!-- æ”¾å¤§é•œæŒ‰é’® -->
            <button id="search-btn" class="search-button" title="è·³è½¬åˆ°è¯¥ç¼–å·">
              ğŸ”
            </button>
          </div>
        </section>
    <section class="view-toggle">
      <button id="btn-view-guitar" class="view-button active-view">å‰ä»–</button>
      <button id="btn-view-lyrics" class="view-button">æ­Œè¯</button>
    </section>


    <main>
      <div id="score-container" class="score-container">
        <!-- SVG å°†æ’å…¥åˆ°è¿™é‡Œ -->
      </div>
      <div id="lyrics-container" class="lyrics-container" style="display:none;"></div>
    </main>

    <footer class="footer">
      <p id="file-info" class="file-info"></p>
    </footer>
  </div>
  <script>
    // ä¸é¦–é¡µç›¸åŒçš„å†Œåˆ«é…ç½®
    const HYMNBOOKS = {
      c: { id: "c", label: "å¤§æœ¬è¯—æ­Œ", prefix: "c", count: 1000, folder: "c" },
      ts: { id: "ts", label: "å°æœ¬è¯—æ­Œ", prefix: "ts", count: 1000, folder: "ts" }
    };

    function getParams() {
      const params = new URLSearchParams(location.search);
      let book = params.get("book") || "c";
      let no = parseInt(params.get("no") || "1", 10);
      if (!(book in HYMNBOOKS)) book = "c";
      const cfg = HYMNBOOKS[book];
      if (isNaN(no) || no < 1) no = 1;
      if (no > cfg.count) no = cfg.count;
      return { book, no };
    }

    function pad4(n) {
      return String(n).padStart(4, "0");
    }

    // å½“å‰è§†å›¾ï¼šguitar = å‰ä»–è°±, lyrics = æ­Œè¯
    let currentView = "guitar";

    // è®¡ç®—æ­Œè¯ JSON æ–‡ä»¶è·¯å¾„
    function getLyricsJsonPath(book, no) {
      const rangeStart = Math.floor((no - 1) / 100) * 100 + 1;
      const rangeEnd = rangeStart + 99;
      const folder = book === "c" ? "c_text" : "ts_text";
      const prefix = book; // c æˆ– ts
      return `assets/${folder}/${prefix}_${rangeStart}_${rangeEnd}.json`;
    }

    // ä» JSON æå–å½“å‰é¦–æ­Œè¯
    function extractLyricsFromJson(data, no) {
      const key = String(no);
      let entry = null;

      if (data[key]) {
        entry = data[key];
      } else if (data.songs && data.songs[key]) {
        entry = data.songs[key];
      } else if (Array.isArray(data)) {
        entry = data.find(item => String(item.no) === key || String(item.id) === key);
      }

      if (!entry) return "æ²¡æœ‰æ‰¾åˆ°è¿™é¦–çš„æ­Œè¯";

      let text = "";
      if (typeof entry === "string") {
        text = entry;
      } else if (Array.isArray(entry)) {
        text = entry.join("\n");
      } else if (entry.text) {
        text = entry.text;
      } else if (entry.lyrics) {
        text = entry.lyrics;
      } else {
        text = JSON.stringify(entry, null, 2);
      }

      return text;
    }

    async function loadLyrics(book, no) {
      const container = document.getElementById("lyrics-container");
      if (!container) return;
      container.innerHTML = "æ­Œè¯åŠ è½½ä¸­â€¦";

      try {
        const path = getLyricsJsonPath(book, no);
        const res = await fetch(path);
        if (!res.ok) throw new Error("not found");
        const data = await res.json();
        const text = extractLyricsFromJson(data, no);
        const html = text.replace(/\n/g, "<br>");
        container.innerHTML = `<div class="lyrics-text">${html}</div>`;
      } catch (e) {
        console.error("loadLyrics error", e);
        container.innerHTML = "æ²¡æœ‰æ‰¾åˆ°æ­Œè¯æˆ–åŠ è½½å¤±è´¥ã€‚";
      }
    }

    function showGuitarView() {
      currentView = "guitar";
      const score = document.getElementById("score-container");
      const lyrics = document.getElementById("lyrics-container");
      const btnG = document.getElementById("btn-view-guitar");
      const btnL = document.getElementById("btn-view-lyrics");

      if (score) score.style.display = "block";
      if (lyrics) lyrics.style.display = "none";

      if (btnG && btnL) {
        btnG.classList.add("active-view");
        btnL.classList.remove("active-view");
      }
    }

    async function showLyricsView(book, no) {
      currentView = "lyrics";
      const score = document.getElementById("score-container");
      const lyrics = document.getElementById("lyrics-container");
      const btnG = document.getElementById("btn-view-guitar");
      const btnL = document.getElementById("btn-view-lyrics");

      if (score) score.style.display = "none";
      if (lyrics) lyrics.style.display = "block";

      if (btnG && btnL) {
        btnG.classList.remove("active-view");
        btnL.classList.add("active-view");
      }

      await loadLyrics(book, no);
    }

    // å½“å‰é€‰ä¸­çš„å†Œï¼ˆç»™æœç´¢ç”¨ï¼‰
    let currentBook = "c";

    function applyBookUI(book) {
      const btnBookC = document.getElementById("btn-book-c");
      const btnBookTs = document.getElementById("btn-book-ts");
      if (btnBookC && btnBookTs) {
        btnBookC.classList.toggle("active", book === "c");
        btnBookTs.classList.toggle("active", book === "ts");
      }
      currentBook = book;
    }

    function updatePage() {
      const { book, no } = getParams();
      const cfg = HYMNBOOKS[book];

      applyBookUI(book);
      const searchInput = document.getElementById("search-no");
      if (searchInput) searchInput.value = no;

      const titleEl = document.getElementById("song-title");
      const subEl = document.getElementById("song-subtitle");
      const infoEl = document.getElementById("file-info");
      const container = document.getElementById("score-container");

      const noStr = pad4(no);
      const filename = `${cfg.prefix}${noStr}_cn_g.svg`;
      const path = `assets/${cfg.folder}/${filename}`;

      titleEl.textContent = `${cfg.label} ç¬¬ ${no} é¦–`;
      if (subEl) subEl.textContent = "";
      if (infoEl) infoEl.textContent = "";

      container.innerHTML = "";
      const img = document.createElement("img");
      img.src = path;
      img.alt = titleEl.textContent;
      img.className = "score-svg";
      container.appendChild(img);

      document.title = `${titleEl.textContent} - å¬ä¼šè¯—æ­Œå‰ä»–è°±`;

      if (currentView === "lyrics") {
        showLyricsView(book, no);
      } else {
        showGuitarView();
      }
    }

    function gotoSong(book, no) {
      const cfg = HYMNBOOKS[book];
      if (no < 1) no = 1;
      if (no > cfg.count) no = cfg.count;
      location.search = `?book=${book}&no=${no}`;
    }

    // å·¦å³ç®­å¤´ä¸Šä¸€é¦–/ä¸‹ä¸€é¦–
    document.getElementById("btn-prev").addEventListener("click", () => {
      const { book, no } = getParams();
      gotoSong(book, no - 1);
    });

    document.getElementById("btn-next").addEventListener("click", () => {
      const { book, no } = getParams();
      gotoSong(book, no + 1);
    });

    // æœç´¢æ é€»è¾‘ï¼ˆå’Œé¦–é¡µä¿æŒä¸€è‡´çš„è¡Œä¸ºï¼‰
    (function setupSearch() {
      const btnBookC = document.getElementById("btn-book-c");
      const btnBookTs = document.getElementById("btn-book-ts");
      const searchInput = document.getElementById("search-no");
      const searchBtn = document.getElementById("search-btn");

      if (!searchInput || !searchBtn || !btnBookC || !btnBookTs) return;

      btnBookC.addEventListener("click", () => {
        applyBookUI("c");
      });

      btnBookTs.addEventListener("click", () => {
        applyBookUI("ts");
      });

      function jumpToSong() {
        const val = searchInput.value.trim();
        if (!val) {
          alert("è¯·è¾“å…¥ç¼–å·ï¼Œä¾‹å¦‚ 7 æˆ– 788");
          return;
        }
        const no = parseInt(val, 10);
        const cfg = HYMNBOOKS[currentBook];
        if (isNaN(no) || no < 1 || no > cfg.count) {
          alert(`è¯·è¾“å…¥ 1 - ${cfg.count} ä¹‹é—´çš„ç¼–å·`);
          return;
        }
        gotoSong(currentBook, no);
      }

      searchBtn.addEventListener("click", jumpToSong);
      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          jumpToSong();
        }
      });
    })();

    // å‰ä»– / æ­Œè¯ åˆ‡æ¢é€»è¾‘
    (function setupViewToggle() {
      const btnG = document.getElementById("btn-view-guitar");
      const btnL = document.getElementById("btn-view-lyrics");
      if (!btnG || !btnL) return;

      btnG.addEventListener("click", () => {
        showGuitarView();
      });

      btnL.addEventListener("click", () => {
        const { book, no } = getParams();
        showLyricsView(book, no);
      });
    })();

    // åˆæ¬¡åŠ è½½å½“å‰é¡µ
    updatePage();
  </script>
</body>
</html>
